name: onemoney-prod

services:
  # Base de donn√©es MySQL
  mysql:
    container_name: mysql-onemoney-prod
    image: mysql:9.2.0
    volumes:
      - ./config/mysql:/etc/mysql/conf.d
      - mysql-prod-data:/var/lib/mysql
    environment:
      - MYSQL_DATABASE=userservice
      - MYSQL_ROOT_PASSWORD=rootpassword
    ports:
      - "3306:3306"
    command: mysqld --lower_case_table_names=1 --skip-mysqlx --character_set_server=utf8mb4 --explicit_defaults_for_timestamp
    networks:
      - onemoney-network

  # Keycloak pour l'authentification
  keycloak:
    container_name: keycloak-onemoney-prod
    image: quay.io/keycloak/keycloak:26.2.3
    command: "start-dev --import-realm"
    volumes:
      - ./realm-config:/opt/keycloak/data/import
      - keycloak-prod-data:/opt/keycloak/data
    environment:
      KC_DB: dev-file
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_FEATURES: scripts
      KC_HTTP_PORT: 9080
      KC_HEALTH_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_URL: http://localhost:9080
      KC_HOSTNAME_ADMIN_URL: http://localhost:9080
    ports:
      - "9080:9080"
    networks:
      - onemoney-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/9080;echo -e 'GET /health/ready HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n' >&3;exit $?"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s


 # Jhipster Registry pour la decouverte de reseau 
  jhipster-registry:
    container_name: jhipster-onemoney-prod
    image: jhipster/jhipster-registry:v7.4.0
    environment:
      _JAVA_OPTIONS: -Xmx512m -Xms256m
      SPRING_PROFILES_ACTIVE: prod,api-docs,oauth2
      SPRING_SECURITY_USER_PASSWORD: admin
      JHIPSTER_REGISTRY_PASSWORD: admin
      SPRING_CLOUD_CONFIG_SERVER_COMPOSITE_0_TYPE: native
      SPRING_CLOUD_CONFIG_SERVER_COMPOSITE_0_SEARCH_LOCATIONS: file:./central-config/
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: jhipster-registry
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: LIPDFNQCKaLs0kG73xqNOo73WnPz5FG7
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_SCOPE: "openid,profile,email"
    ports:
      - "8761:8761"
    networks:
      - onemoney-network
    depends_on:
      keycloak:
        condition: service_healthy
    restart: on-failure

 # Gateway pour le routing 
  gateway:
    container_name: gateway-onemoney-prod
    image: seckkane/gateway:0.0.1
    environment:
      _JAVA_OPTIONS: -Xmx512m -Xms256m
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_ENABLED: false
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://admin:admin@jhipster-registry:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      EUREKA_INSTANCE_HOSTNAME: gateway
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: gateway-onemoney
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: AgGWBShS9B3qUHkSe1f5YoY6ruRCBd93
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_SCOPE: "openid,profile,email"
    ports:
      - "8080:8080"
    networks:
      - onemoney-network
    depends_on:
      jhipster-registry:
        condition: service_started
      keycloak:
        condition: service_healthy
    restart: on-failure


   # User-service pour la gestion des users et L'auth
  userservice:
    container_name: userservice-onemoney-prod
    image: seckkane/user-service:0.0.1
    environment:
      _JAVA_OPTIONS: -Xmx512m -Xms256m
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/userservice?useUnicode=true&characterEncoding=utf8&useSSL=false&createDatabaseIfNotExist=true&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: rootpassword
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_LIQUIBASE_CONTEXTS: prod
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://admin:admin@jhipster-registry:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      EUREKA_INSTANCE_HOSTNAME: userservice
      KEYCLOAK_SERVER_URL: http://keycloak:9080
      KEYCLOAK_REALM: jhipster
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: user-service
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: 1UNh6DMCHDKNHqGvZmL4nNUwDwkh3Zpt
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_SCOPE: "openid,profile,email"
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:9080/realms/jhipster
    ports:
      - "8081:8081"
    networks:
      - onemoney-network
    depends_on:
      mysql:
        condition: service_started
      jhipster-registry:
        condition: service_started
      keycloak:
        condition: service_healthy
    restart: on-failure

  account-service:
    container_name: accountservice-onemoney-prod
    image: aminata02/account-service:1.0
    environment:
      _JAVA_OPTIONS: -Xmx512m -Xms256m
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/accountdb?useUnicode=true&characterEncoding=utf8&useSSL=false&createDatabaseIfNotExist=true&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: rootpassword
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_LIQUIBASE_CONTEXTS: prod
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://admin:admin@jhipster-registry:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      EUREKA_INSTANCE_HOSTNAME: account-service
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: account-service
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: 4Xl20vvILbLjgLCKxMJIdKbervZIi9jE
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_SCOPE: "openid,profile,email"
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:9080/realms/jhipster
      SPRING_CLOUD_CONFIG_ENABLED: false
      KEYCLOAK_JWK_URI: http://keycloak:9080/realms/jhipster/protocol/openid-connect/certs
    ports:
      - "8092:8082" # Mon 82 est occupe
    networks:
      - onemoney-network
    depends_on:
      mysql:
        condition: service_started
      jhipster-registry:
        condition: service_started
      keycloak:
        condition: service_healthy
    restart: on-failure

networks:
  onemoney-network:
    driver: bridge

volumes:
  mysql-prod-data:
  keycloak-prod-data:
